<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Your Status ‚Äî Chess Simul</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@400;500;600;700&family=Press+Start+2P&family=Share+Tech+Mono&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css?v=2">
  <style>
    .queue-position {
      font-size: 3rem;
      font-weight: 700;
      color: var(--brand-blue);
      line-height: 1.1;
    }

    .activity-strip {
      width: 100%;
      display: flex;
      gap: 8px;
    }

    .activity-box {
      flex: 1;
      background: var(--bg-white);
      border: 1px solid var(--stroke-default);
      border-radius: 8px;
      padding: 10px 8px;
      text-align: center;
      font-size: 0.875rem;
    }

    .activity-box .activity-label {
      font-weight: 700;
      color: var(--text-heading);
      margin-bottom: 4px;
    }

    .activity-box .activity-value {
      color: var(--brand-blue);
      font-weight: 600;
      font-size: 1.1rem;
    }

    .playing-alert {
      background: linear-gradient(135deg, #3F8CFF, #8B5CF6);
      color: var(--text-white);
      border-radius: 16px;
      padding: 32px 24px;
      text-align: center;
      width: 100%;
    }

    .playing-alert h2 {
      color: var(--text-white);
      font-size: 1.75rem;
      margin-bottom: 8px;
    }

    .playing-alert p {
      color: rgba(255, 255, 255, 0.9);
    }

    .moves-input {
      font-size: 3rem !important;
      text-align: center;
      font-weight: 700;
      letter-spacing: 4px;
      padding: 20px 16px !important;
    }

    .game-over-section h1 {
      font-size: 1.5rem;
    }
  </style>
</head>
<body>
  <div class="page-container">

    <!-- Mode A: Waiting in Queue -->
    <div id="mode-queued">
      <div class="text-center mb-24" style="width:100%;">
        <p class="text-caption mb-8">Welcome,</p>
        <h1 id="player-name-display">‚Äî</h1>
      </div>

      <div class="card text-center w-full mb-16">
        <p class="text-caption mb-8">Your position in the queue</p>
        <p id="queue-position" class="queue-position">‚Äî</p>
      </div>

      <p class="text-center text-body mb-24">Get ready! The organizer will call you when a board is free.</p>

      <div class="activity-strip mb-8">
        <div class="activity-box">
          <div class="activity-label">Playing</div>
          <div class="activity-value" id="strip-playing">0</div>
        </div>
        <div class="activity-box">
          <div class="activity-label">In Queue</div>
          <div class="activity-value" id="strip-queued">0</div>
        </div>
        <div class="activity-box">
          <div class="activity-label">Completed</div>
          <div class="activity-value" id="strip-completed">0</div>
        </div>
      </div>
    </div>

    <!-- Mode B: Playing -->
    <div id="mode-playing" class="hidden" style="width:100%;display:none;">
      <!-- Sub-view: Alert -->
      <div id="playing-alert" style="width:100%;">
        <div class="playing-alert mb-24">
          <h2>You're up!</h2>
          <p>Head to the chess board ‚Äî the organizer will direct you.</p>
        </div>
        <button id="got-it-btn" class="btn btn-primary w-full mt-16">Got it!</button>
      </div>

      <!-- Sub-view: Move entry -->
      <div id="playing-entry" class="hidden" style="width:100%;">
        <div class="game-over-section text-center mb-24" style="width:100%;">
          <h1 class="mb-8">Game Over!</h1>
          <p class="text-body">How many moves did you survive?</p>
        </div>

        <label for="moves-input" class="mb-8" style="display:block;font-weight:600;text-align:center;">Move Count</label>
        <input type="number" id="moves-input" class="moves-input mb-8 w-full" min="0" max="999" placeholder="0" inputmode="numeric">
        <div style="display:flex; gap:8px; width:100%; margin-top:16px;">
          <button id="btn-won" class="btn btn-secondary w-full" style="flex:1;" type="button">üëë I Won!</button>
          <button id="btn-drew" class="btn btn-secondary w-full" style="flex:1;" type="button">ü§ù I Drew!</button>
        </div>
        <p id="outcome-display" class="text-center text-caption mt-8 hidden"></p>
        <p id="submit-error" class="hidden" style="color:#dc3545;font-size:0.875rem;text-align:center;"></p>
        <button id="submit-btn" class="btn btn-primary w-full mt-16">Submit My Score</button>
      </div>
    </div>

  </div>

  <script type="module">
    import { firebaseConfig } from './firebase-config.js';
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
    import { getDatabase, ref, get, set, push, onValue, update }
      from "https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js";

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // Check localStorage for player identity
    const playerId = localStorage.getItem('chessPlayerId');
    const playerName = localStorage.getItem('chessPlayerName');

    if (!playerId) {
      window.location.href = 'join.html';
    }

    // DOM references
    const modeQueued = document.getElementById('mode-queued');
    const modePlaying = document.getElementById('mode-playing');
    const playerNameDisplay = document.getElementById('player-name-display');
    const queuePositionEl = document.getElementById('queue-position');
    const gotItBtn = document.getElementById('got-it-btn');
    const playingAlert = document.getElementById('playing-alert');
    const playingEntry = document.getElementById('playing-entry');
    const movesInput = document.getElementById('moves-input');
    const submitBtn = document.getElementById('submit-btn');
    const submitError = document.getElementById('submit-error');

    // Set player name
    if (playerNameDisplay) {
      playerNameDisplay.textContent = playerName || '‚Äî';
    }

    // Switch to Mode B (playing)
    function showPlayingMode() {
      modeQueued.classList.add('hidden');
      modeQueued.style.display = 'none';
      modePlaying.classList.remove('hidden');
      modePlaying.style.display = '';
    }

    // "Got it!" button ‚Äî show move entry form
    gotItBtn.addEventListener('click', () => {
      playingAlert.classList.add('hidden');
      playingAlert.style.display = 'none';
      playingEntry.classList.remove('hidden');
      playingEntry.style.display = '';
      movesInput.focus();
    });

    // Immediately read player status from Firebase on load
    const playerRef = ref(db, 'queue/' + playerId);
    try {
      const snapshot = await get(playerRef);
      if (!snapshot.exists()) {
        localStorage.removeItem('chessPlayerId');
        localStorage.removeItem('chessPlayerName');
        window.location.href = 'join.html';
      } else {
        const data = snapshot.val();
        if (data.status === 'playing') {
          showPlayingMode();
        } else if (data.status === 'completed') {
          window.location.href = 'thankyou.html';
        }
      }
    } catch (e) {
      // Continue with listener
    }

    // Attach real-time listener for player status changes
    onValue(playerRef, (snapshot) => {
      if (!snapshot.exists()) return;
      const data = snapshot.val();
      if (data.status === 'playing') {
        showPlayingMode();
      } else if (data.status === 'completed') {
        window.location.href = 'thankyou.html';
      }
    });

    // Listen to full queue to compute position and activity counts
    onValue(ref(db, 'queue'), (snapshot) => {
      if (!snapshot.exists()) {
        queuePositionEl.textContent = '‚Äî';
        document.getElementById('strip-playing').textContent = '0';
        document.getElementById('strip-queued').textContent = '0';
        document.getElementById('strip-completed').textContent = '0';
        return;
      }
      const queue = snapshot.val();
      const entries = Object.entries(queue);

      const queued = entries
        .filter(([, v]) => v.status === 'queued')
        .sort((a, b) => a[1].queuedAt - b[1].queuedAt);
      const playingCount = entries.filter(([, v]) => v.status === 'playing').length;
      const completedCount = entries.filter(([, v]) => v.status === 'completed').length;

      const position = queued.findIndex(([id]) => id === playerId);
      queuePositionEl.textContent = position >= 0 ? '#' + (position + 1) : '‚Äî';

      document.getElementById('strip-playing').textContent = playingCount;
      document.getElementById('strip-queued').textContent = queued.length;
      document.getElementById('strip-completed').textContent = completedCount;
    });

    // Outcome selection
    let selectedOutcome = 'lost';
    const btnWon = document.getElementById('btn-won');
    const btnDrew = document.getElementById('btn-drew');
    const outcomeDisplay = document.getElementById('outcome-display');

    function setOutcome(outcome) {
      selectedOutcome = outcome;
      btnWon.classList.toggle('btn-primary', outcome === 'won');
      btnWon.classList.toggle('btn-secondary', outcome !== 'won');
      btnDrew.classList.toggle('btn-primary', outcome === 'drew');
      btnDrew.classList.toggle('btn-secondary', outcome !== 'drew');
      if (outcome === 'won') {
        outcomeDisplay.textContent = 'üëë +50 bonus points!';
        outcomeDisplay.classList.remove('hidden');
      } else if (outcome === 'drew') {
        outcomeDisplay.textContent = 'ü§ù +25 bonus points!';
        outcomeDisplay.classList.remove('hidden');
      } else {
        outcomeDisplay.classList.add('hidden');
      }
    }

    btnWon.addEventListener('click', () => {
      setOutcome(selectedOutcome === 'won' ? 'lost' : 'won');
    });
    btnDrew.addEventListener('click', () => {
      setOutcome(selectedOutcome === 'drew' ? 'lost' : 'drew');
    });

    // Submit score
    submitBtn.addEventListener('click', async () => {
      submitError.classList.add('hidden');

      const movesVal = movesInput.value.trim();
      if (movesVal === '' || isNaN(parseInt(movesVal, 10))) {
        submitError.textContent = 'Please enter a valid number of moves.';
        submitError.classList.remove('hidden');
        return;
      }

      const moves = parseInt(movesVal, 10);
      if (moves < 0 || moves > 999) {
        submitError.textContent = 'Moves must be between 0 and 999.';
        submitError.classList.remove('hidden');
        return;
      }

      submitBtn.disabled = true;
      submitBtn.textContent = 'Submitting...';

      try {
        const name = playerName || 'Unknown';

        // 1. Write score to /scores
        const bonus = selectedOutcome === 'won' ? 50 : selectedOutcome === 'drew' ? 25 : 0;
        const scoreRef = push(ref(db, 'scores'));
        await set(scoreRef, {
          name: name,
          moves: moves,
          outcome: selectedOutcome,
          rankingScore: moves + bonus,
          completedAt: Date.now()
        });

        // 2. Update player status to completed
        await update(ref(db, 'queue/' + playerId), {
          status: 'completed',
          moves: moves
        });

        // 3. Auto-assign: if fewer than 3 playing, promote next queued player
        const queueSnapshot = await get(ref(db, 'queue'));
        if (queueSnapshot.exists()) {
          const allQueue = queueSnapshot.val();
          const allEntries = Object.entries(allQueue);
          const playingNow = allEntries.filter(([, v]) => v.status === 'playing').length;

          if (playingNow < 3) {
            const nextQueued = allEntries
              .filter(([, v]) => v.status === 'queued')
              .sort((a, b) => a[1].queuedAt - b[1].queuedAt);

            if (nextQueued.length > 0) {
              const [nextId] = nextQueued[0];
              await update(ref(db, 'queue/' + nextId), {
                status: 'playing'
              });
            }
          }
        }

        // 4. Redirect to thank you
        window.location.href = 'thankyou.html';
      } catch (err) {
        submitError.textContent = 'Something went wrong. Please try again.';
        submitError.classList.remove('hidden');
        submitBtn.disabled = false;
        submitBtn.textContent = 'Submit My Score';
      }
    });
  </script>
</body>
</html>
